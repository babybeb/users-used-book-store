<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>중고 서적 직거래(Ur's ur)</title>
</head>
<script>
    window.onload = start;
    var isSignIn = false;
    async function get(path, headers = {}){
        const url = path;
        const options = {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                ...headers,
            },
        };
        const res = await fetch(url, options);
        const data = await res.json();
        if(res.ok){
            return data;
        } else {
            throw Error(data);
        }
    }

    async function del(path, headers = {}){
        const url = path;
        const options = {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                ...headers,
            },
        };
        const res = await fetch(url, options);
    }

    function start(){
        sessionStorage.clear();
        get("/api/sign/session", {})
            .then((data) => {
                //로그인상태인지 확인하는 매핑(로그인 시 nickname 반환, 아니면 "" 반환)
                if(data.nickname != "" && data.nickname != null){
                    const board = document.getElementById("sign");
                    const p = document.getElementById("parent");
                    p.removeChild(board);

                    const nickname = document.createElement("p");
                    nickname.innerHTML = data.nickname+" 님 환영합니다.";
                    p.appendChild(nickname);

                    const signOut = document.createElement("button");
                    signOut.innerHTML = "로그아웃";
                    signOut.setAttribute("onClick", "signOut()");
                    p.appendChild(signOut);

                    const info = document.createElement("button");
                    info.innerHTML = "내 정보 보기";
                    info.setAttribute("onClick", "myInfo()");
                    p.appendChild(info);
                }
                isSignIn = true;
            })
            .catch((error) => {
                console.log(error);
                isSignIn = false;
            });
    }

    function signOut(){
        del("/api/sign", {});
        location.reload();
    }

    function signIn(){
        window.open('/sign.html', '_self');
    }

    function join(){
        window.open('/createMemberForm.html', '_self');
    }

    function sale(){
        if(isSignIn){
            window.open("/sale.html", "_self");
        } else {
            alert("로그인 후 이용해주세요");
        }
    }

    function myInfo(){
        window.open("/member.html", "_self");
    }

    function itemSearch(){
        const searchSelect = document.getElementById("select").value;
        const searchValue = document.getElementById("searchText").value;
        sessionStorage.setItem("searchSelect", searchSelect);
        sessionStorage.setItem("searchValue", searchValue);
        window.open("/itemSearch.html", "_self");
        return false;
    }

</script>
<body>
    <h1>Ur's ur</h1>

    <section class="notice">
        <p>중고로 팔고 싶은 책,</p>
        <p>중고로 사고 싶은 책,</p>
        <p>원하는 곳 어디에서나 거래하세요!</p>
    </section>

    <section class="search">
        <form method="Get">
            <select id="select">
                <option value="title">책 제목</option>
                <option value="category">카테고리</option>
                <option value="dealArea">지역</option>
            </select>
            <input type="text" id="searchText" name="title" placeholder="검색 값 입력" required>
            <button type="submit" id="searchValue" onclick="return itemSearch()">검색</button>
        </form>
    </section>

    <button type="button" onclick="sale()">판매등록</button>
    <div id="parent">
        <section class="sign" id="sign">
            <button type="button" onclick="signIn()">로그인</button>
            <button type="button" onclick="join()">회원가입</button>
        </section>
    </div>
</body>
</html>